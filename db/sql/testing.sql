with recursive dir_tree as (
    select fs_root.id,
           fs_root.directory,
           fs_root.basename,
           fs_root.parent,
           1 as level
    from fs_items fs_root
    where id = 143579634196287489
    union
    select fs_contents.id,
           fs_contents.directory,
           fs_contents.basename,
           fs_contents.parent,
           dir_tree.level + 1 as level
    from fs_items fs_contents
    inner join dir_tree on dir_tree.id = fs_contents.parent
)
select * 
from dir_tree
where dir_tree.id <> all(ARRAY[143579634196287489, 143579634196287489, 143579634204676097, 143579634213064705, 143579634217259009, 143579634225647617, 143579634234036225, 143579634238230529, 143579634246619137, 143579634250813441, 143579634259202049, 143579634267590657, 143579634275979265, 143579634280173569, 143579634288562177, 143579634296950785, 143579634301145089, 143579634309533697, 143579634313728001, 143579634322116609, 143579634330505217, 143579634338893825, 143579634343088129, 143579634351476737, 143579634359865345, 143579634368253953, 143579634376642561, 143579634385031169, 143579634393419777, 143579634397614081, 143579634406002689, 143579634414391297, 143579634418585601, 143579634426974209, 143579634431168513, 143579634439557121, 143579634443751425, 143579634452140033, 143579634456334337, 143579634464722945, 143579634473111553, 143579634481500161, 143579634489888769, 143579634498277377, 143579634502471681, 143579634510860289, 143579634515054593, 143579634523443201, 143579634527637505, 143579634536026113, 143579634544414721, 143579634548609025, 143579634556997633, 143579634565386241, 143579634569580545, 143579634577969153, 143579634582163457, 143579634590552065, 143579634598940673, 143579634607329281, 143579634611523585, 143579634619912193, 143579634628300801, 143579634636689409, 143579634640883713, 143579634649272321, 143579634653466625, 143579634661855233, 143579634666049537, 143579634670243841, 143579634678632449, 143579634687021057, 143579634695409665, 143579634699603969, 143579634707992577, 143579634712186881, 143579634720575489, 143579634728964097, 143579634737352705, 143579634745741313, 143579634749935617, 143579634758324225, 143579634766712833, 143579634775101441, 143579634779295745, 143579634787684353, 143579634791878657, 143579634796072961, 143579634804461569, 143579634808655873, 143579634817044481, 143579634825433089, 143579634833821697, 143579634838016001, 143579634846404609, 143579634850598913, 143579634858987521, 143579634867376129, 143579634871570433, 143579634879959041, 143579634888347649, 143579634892541953, 143579634900930561, 143579634909319169, 143579634917707777, 143579634921902081, 143579634930290689, 143579634934484993, 143579634942873601, 143579634951262209, 143579634959650817, 143579634968039425, 143579634976428033, 143579634984816641, 143579634989010945, 143579634997399553, 143579635001593857, 143579635009982465, 143579635014176769, 143579635022565377, 143579635030953985, 143579635035148289, 143579635043536897, 143579635068702721, 143579635072897025, 143579635089674241, 143579635098062849, 143579635106451457, 143579635114840065, 143579635123228673, 143579635127422977, 143579635135811585, 143579635144200193, 143579635152588801, 143579635156783105, 143579635165171713, 143579635173560321, 143579635181948929, 143579635190337537, 143579635198726145, 143579635207114753, 143579635215503361, 143579635223891969, 143579635228086273, 143579635236474881, 143579635244863489, 143579635253252097, 143579635261640705, 143579635270029313, 143579635278417921, 143579635286806529, 143579635295195137, 143579635303583745, 143579635307778049, 143579635320360961, 143579635328749569, 143579635332943873, 143579635341332481, 143579635349721089, 143579635358109697, 143579635366498305, 143579635379081217, 143579635387469825, 143579635395858433, 143579635400052737, 143579635408441345, 143579635412635649, 143579635421024257, 143579635429412865, 143579635437801473, 143579635446190081, 143579635450384385, 143579635458772993, 143579635467161601, 143579635475550209, 143579635483938817, 143579635492327425, 143579635500716033, 143579635509104641, 143579635513298945, 143579635521687553, 143579635530076161, 143579635538464769, 143579635546853377, 143579635551047681, 143579635559436289, 143579635567824897, 143579635576213505, 143579635584602113, 143579635592990721, 143579635601379329, 143579635609767937, 143579635618156545, 143579635626545153, 143579635634933761, 143579635643322369, 143579635651710977, 143579635660099585, 143579635664293889, 143579635672682497, 143579635681071105, 143579635689459713, 143579635697848321, 143579635706236929, 143579635714625537, 143579635723014145, 143579635727208449, 143579635735597057, 143579635743985665, 143579635752374273, 143579635760762881, 143579635769151489, 143579635777540097, 143579635785928705, 143579635794317313, 143579635802705921, 143579635806900225, 143579635815288833, 143579635823677441, 143579635832066049, 143579635836260353, 143579635844648961, 143579635853037569, 143579635861426177, 143579635869814785, 143579635878203393, 143579635882397697, 143579635890786305, 143579635899174913, 143579635907563521, 143579635911757825, 143579635920146433, 143579635928535041, 143579635936923649]);





with recursive dir_tree as (
    select fs_root.id,
           fs_root.parent,
           1 as level
    from fs_items fs_root
    where id = 143579635014176769
    union
    select fs_contents.id,
           fs_contents.parent,
           dir_tree.level + 1 as level
    from fs_items fs_contents
    inner join dir_tree on dir_tree.parent = fs_contents.id
    where fs_contents.item_type = 2
)
select event_listeners.endpoint
from dir_tree
join event_listeners on (
    ref_table = 'fs_items' and
    ref_id = dir_tree.id
);

insert into event_listeners (id, endpoint, ref_table, ref_id) values
('48e89397-9291-4458-894b-a000d81efef8', ARRAY['fs_items:created'], 'http://localhost:80/hooks/fs-server', 'fs_items', 140600863562403841),
('f4f8bc5c-54c7-4e61-a77a-d0bea2d41966', ARRAY['fs_items:updated'], 'http://localhost:80/hooks/fs-server', 'fs_items', 143579634196287489),
('6202dee6-1915-4994-b84c-735b83c4fc57', ARRAY['fs_items:created'], 'http://localhost:80/hooks/fs-server', 'fs_items', 143579634989010945),
('d381d256-ffab-443a-ad8c-5eed72af0ec5', ARRAY['fs_items:deleted'], 'http://localhost:80/hooks/fs-server', 'fs_items', 143579635014176769),
('54173efe-63f2-4e35-8a88-29f9810c090d', ARRAY['fs_items:updated'], 'http://localhost:80/hooks/fs-server', 'fs_items', 143579634687021057),
('bd666a5b-6340-4b47-ba74-ec27d29c355e', ARRAY['fs_items:updated'], 'http://localhost:80/hooks/fs-server', 'fs_items', 143579635945312257),
('b4e1a33f-c1ca-4c54-8df1-244f3e3a4f10', ARRAY['fs_items:updated'], 'http://localhost:80/hooks/fs-server', 'fs_items', 143579633835577345),
('a8db5eec-0a51-46b2-8f13-5faaf7afc782', ARRAY['fs_items:updated'], 'http://localhost:80/hooks/fs-server', 'fs_items', 143579637992132609),
('9c15d222-7efc-4e22-b4a3-5aded60d0462', ARRAY['fs_items:updated'], 'http://localhost:80/hooks/fs-server', 'fs_items', 143579635546853377),
('98b0b0b8-92f9-4b2b-9072-0ba75ed70939', ARRAY['fs_items:updated'], 'http://localhost:80/hooks/fs-server', 'fs_items', 143579634989010945);